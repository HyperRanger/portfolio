<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --accent: #3b82f6;
            --surface: #1e293b;
            --text: #f1f5f9;
            --muted: #94a3b8;
        }
        .glass-morphism {
            background: rgba(30, 41, 59, 0.7);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
        }
        .tag-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-blue-900">
    <nav class="glass-morphism px-4 py-3 mb-8 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">Project Editor</h1>
            <div class="flex items-center space-x-4">
                <button onclick="location.href='dashboard.html'" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 mb-8">
        <form id="projectForm" class="glass-morphism rounded-xl p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" for="title">
                            Project Title
                        </label>
                        <input type="text" id="title" name="title" required
                               class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" for="description">
                            Description
                        </label>
                        <textarea id="description" name="description" rows="4" required
                                  class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Tags
                        </label>
                        <div id="tagContainer" class="flex flex-wrap gap-2 mb-2"></div>
                        <div class="flex">
                            <input type="text" id="tagInput"
                                   class="tag-input flex-grow px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white"
                                   placeholder="Add a tag and press Enter">
                            <button type="button" id="addTagBtn"
                                    class="ml-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
                                Add
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" for="imageUrl">
                            Image URL
                        </label>
                        <input type="url" id="imageUrl" name="imageUrl"
                               class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" for="demoUrl">
                            Demo URL
                        </label>
                        <input type="url" id="demoUrl" name="demoUrl"
                               class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" for="githubUrl">
                            GitHub URL
                        </label>
                        <input type="url" id="githubUrl" name="githubUrl"
                               class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" for="status">
                            Status
                        </label>
                        <select id="status" name="status" required
                                class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-blue-500">
                            <option value="draft">Draft</option>
                            <option value="active">Active</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="location.href='dashboard.html'"
                        class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
                    Save Project
                </button>
            </div>
        </form>
    </div>

    <script>
        let supabaseClient = null;
        let currentTags = [];
        let editingProjectId = null;

        function checkAuth() {
            const session = localStorage.getItem('adminSession');
            const token = localStorage.getItem('adminToken');
            
            if (!session && !token) {
                window.location.href = 'login.html';
                return;
            }

            if (session) {
                try {
                    const { expiresAt } = JSON.parse(session);
                    if (expiresAt && new Date(expiresAt) < new Date()) {
                        localStorage.removeItem('adminSession');
                        window.location.href = 'login.html';
                        return;
                    }
                } catch (e) {
                    console.error('Invalid session:', e);
                    localStorage.removeItem('adminSession');
                    window.location.href = 'login.html';
                    return;
                }
            }
        }

        function renderTags() {
            const container = document.getElementById('tagContainer');
            container.innerHTML = '';
            currentTags.forEach((tag, index) => {
                const tagElement = document.createElement('span');
                tagElement.className = 'px-3 py-1 rounded-full bg-blue-900 text-blue-200 flex items-center';
                tagElement.innerHTML = `
                    ${tag}
                    <button type="button" onclick="removeTag(${index})" class="ml-2 text-blue-300 hover:text-blue-100">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(tagElement);
            });
        }

        function addTag(tag) {
            tag = tag.trim();
            if (tag && !currentTags.includes(tag)) {
                currentTags.push(tag);
                renderTags();
            }
            document.getElementById('tagInput').value = '';
        }

        function removeTag(index) {
            currentTags.splice(index, 1);
            renderTags();
        }

        async function loadProject(id) {
            try {
                const session = localStorage.getItem('adminSession');
                const token = localStorage.getItem('adminToken');
                
                let project;
                if (supabaseClient && session) {
                    const { data, error } = await supabaseClient
                        .from('projects')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    if (error) throw error;
                    project = data;
                } else {
                    const response = await fetch(`/api/projects/${id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch project');
                    project = await response.json();
                }

                document.getElementById('title').value = project.title || '';
                document.getElementById('description').value = project.description || '';
                document.getElementById('imageUrl').value = project.imageUrl || '';
                document.getElementById('demoUrl').value = project.demoUrl || '';
                document.getElementById('githubUrl').value = project.githubUrl || '';
                document.getElementById('status').value = project.status || 'draft';
                
                currentTags = project.tags || [];
                renderTags();

            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project');
            }
        }

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                imageUrl: document.getElementById('imageUrl').value,
                demoUrl: document.getElementById('demoUrl').value,
                githubUrl: document.getElementById('githubUrl').value,
                status: document.getElementById('status').value,
                tags: currentTags
            };

            try {
                const session = localStorage.getItem('adminSession');
                const token = localStorage.getItem('adminToken');

                if (supabaseClient && session) {
                    const operation = editingProjectId ? 
                        supabaseClient
                            .from('projects')
                            .update(projectData)
                            .eq('id', editingProjectId) :
                        supabaseClient
                            .from('projects')
                            .insert([projectData]);
                    
                    const { error } = await operation;
                    if (error) throw error;
                } else {
                    const url = editingProjectId ? 
                        `/api/projects/${editingProjectId}` : 
                        '/api/projects';
                    
                    const response = await fetch(url, {
                        method: editingProjectId ? 'PUT' : 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(projectData)
                    });
                    
                    if (!response.ok) throw new Error('Failed to save project');
                }

                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error('Error saving project:', error);
                alert('Failed to save project');
            }
        });

        document.getElementById('tagInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(e.target.value);
            }
        });

        document.getElementById('addTagBtn').addEventListener('click', () => {
            const input = document.getElementById('tagInput');
            addTag(input.value);
        });

        window.addEventListener('load', async () => {
            checkAuth();

            try {
                const response = await fetch('/api/admin/status');
                const data = await response.json();
                if (data.success && data.supabase) {
                    try {
                        supabaseClient = supabase.createClient(data.supabase.url, data.supabase.anonKey);
                        console.log('Supabase client initialized');
                    } catch (err) {
                        console.warn('Failed to initialize Supabase client', err);
                    }
                }

                // Check if we're editing an existing project
                const params = new URLSearchParams(window.location.search);
                const projectId = params.get('id');
                if (projectId) {
                    editingProjectId = projectId;
                    await loadProject(projectId);
                }
            } catch (error) {
                console.error('Error initializing project editor:', error);
            }
        });
    </script>
</body>
</html>