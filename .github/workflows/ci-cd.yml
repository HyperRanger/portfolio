name: Portfolio CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run backend tests
        working-directory: ./backend
        run: npm test

      - name: Deploy to Render
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          curl -X POST $RENDER_DEPLOY_HOOK_URL

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/portfolio-backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/portfolio-backend:latest
          cache-to: type=inline

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Set up kubeconfig
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Update deployment secrets
        run: |
          kubectl create secret generic portfolio-secrets \
            --from-literal=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --from-literal=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --from-literal=SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} \
            --from-literal=EMAIL_USER=${{ secrets.EMAIL_USER }} \
            --from-literal=EMAIL_PASS=${{ secrets.EMAIL_PASS }} \
            --from-literal=JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --from-literal=ADMIN_BOOTSTRAP_SECRET=${{ secrets.ADMIN_BOOTSTRAP_SECRET }} \
            -n ${{ env.KUBERNETES_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Kubernetes
        run: |
          # Update image in deployment
          kubectl set image deployment/portfolio-backend \
            portfolio-backend=${{ env.DOCKER_REGISTRY }}/portfolio-backend:${{ github.sha }} \
            -n ${{ env.KUBERNETES_NAMESPACE }}

          # Verify deployment
          kubectl rollout status deployment/portfolio-backend -n ${{ env.KUBERNETES_NAMESPACE }}

      - name: Run post-deployment tests
        run: |
          # Wait for service to be ready
          sleep 30

          # Run health check
          ENDPOINT=$(kubectl get ingress portfolio-ingress -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.rules[0].host}')
          curl -f https://$ENDPOINT/api/health

  monitoring:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Configure monitoring
        run: |
          # Install Prometheus Operator if not exists
          kubectl apply -f https://github.com/prometheus-operator/prometheus-operator/releases/download/v0.63.0/bundle.yaml

          # Apply monitoring configuration
          kubectl apply -f k8s/monitoring/
