<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Render Deployment Checker</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        background: #1a1a1a;
        color: #fff;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .status-card {
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .online {
        background: #4caf50;
      }
      .offline {
        background: #f44336;
      }
      .checking {
        background: #ff9800;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      pre {
        background: #333;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
      .error {
        color: #f44336;
      }
      .success {
        color: #4caf50;
      }
      .warning {
        color: #ff9800;
      }
      .info {
        color: #2196f3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Render Backend Deployment Checker</h1>

      <div class="status-card">
        <h2>üì° Backend Service Status</h2>
        <div id="backend-status">
          <span class="status-indicator checking"></span>
          <span>Checking backend status...</span>
        </div>
        <button onclick="checkBackend()">Check Backend</button>
        <button onclick="wakeUpBackend()">Wake Up Backend</button>
      </div>

      <div class="status-card">
        <h2>üîê Admin Interface Status</h2>
        <div id="admin-status">
          <span class="status-indicator checking"></span>
          <span>Checking admin interface...</span>
        </div>
        <button onclick="checkAdmin()">Check Admin</button>
        <button onclick="openAdmin()">Open Admin Interface</button>
      </div>

      <div class="status-card">
        <h2>üìß Contact Form Status</h2>
        <div id="contact-status">
          <span class="status-indicator checking"></span>
          <span>Checking contact form...</span>
        </div>
        <button onclick="checkContactForm()">Test Contact Form</button>
      </div>

      <div class="status-card">
        <h2>üóÑÔ∏è Database Status</h2>
        <div id="database-status">
          <span class="status-indicator checking"></span>
          <span>Checking database connection...</span>
        </div>
        <button onclick="checkDatabase()">Check Database</button>
      </div>

      <div class="status-card">
        <h2>üìä Deployment Information</h2>
        <div id="deployment-info">
          <p>
            <strong>Backend URL:</strong> https://portfolio-xj76.onrender.com
          </p>
          <p>
            <strong>Admin URL:</strong>
            https://portfolio-xj76.onrender.com/admin
          </p>
          <p>
            <strong>API Base:</strong> https://portfolio-xj76.onrender.com/api
          </p>
        </div>
      </div>

      <div class="status-card">
        <h2>üîß Troubleshooting Steps</h2>
        <div id="troubleshooting">
          <ol>
            <li>
              <strong>Check Render Dashboard:</strong> Go to render.com and
              check your service status
            </li>
            <li>
              <strong>Check Environment Variables:</strong> Ensure EMAIL_USER,
              EMAIL_PASS, SUPABASE_URL are set
            </li>
            <li>
              <strong>Check Logs:</strong> Look at Render service logs for
              errors
            </li>
            <li><strong>Redeploy:</strong> Try triggering a manual redeploy</li>
            <li>
              <strong>Free Tier Limits:</strong> Free services sleep after 15
              minutes of inactivity
            </li>
          </ol>
        </div>
      </div>

      <div id="results"></div>
    </div>

    <script>
      const BACKEND_URL = "https://portfolio-xj76.onrender.com";
      const API_URL = BACKEND_URL + "/api";

      function updateStatus(elementId, status, message) {
        const element = document.getElementById(elementId);
        const indicator = element.querySelector(".status-indicator");
        const text =
          element.querySelector("span:last-child") || element.lastElementChild;

        indicator.className = `status-indicator ${status}`;
        text.textContent = message;
      }

      function showResult(title, success, data) {
        const results = document.getElementById("results");
        const resultDiv = document.createElement("div");
        resultDiv.className = "status-card";
        resultDiv.innerHTML = `
                <h3 class="${success ? "success" : "error"}">${
          success ? "‚úÖ" : "‚ùå"
        } ${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        results.appendChild(resultDiv);
      }

      async function checkBackend() {
        updateStatus(
          "backend-status",
          "checking",
          "Checking backend health..."
        );

        try {
          const response = await fetch(`${API_URL}/health`);
          const data = await response.json();

          if (response.ok && data.success) {
            updateStatus(
              "backend-status",
              "online",
              `‚úÖ Backend is online - ${data.message}`
            );
            showResult("Backend Health Check", true, data);
          } else {
            updateStatus(
              "backend-status",
              "offline",
              `‚ùå Backend responded with error`
            );
            showResult("Backend Health Check", false, data);
          }
        } catch (error) {
          updateStatus(
            "backend-status",
            "offline",
            `‚ùå Backend is offline - ${error.message}`
          );
          showResult("Backend Health Check", false, { error: error.message });
        }
      }

      async function wakeUpBackend() {
        updateStatus(
          "backend-status",
          "checking",
          "Waking up backend service..."
        );

        // Try multiple endpoints to wake up the service
        const endpoints = ["/api/health", "/api/admin/status", "/admin"];

        for (const endpoint of endpoints) {
          try {
            console.log(`Pinging ${BACKEND_URL}${endpoint}`);
            await fetch(`${BACKEND_URL}${endpoint}`, {
              method: "GET",
              mode: "no-cors", // Avoid CORS issues for wake-up calls
            });
            await new Promise((resolve) => setTimeout(resolve, 1000));
          } catch (error) {
            console.log(`Wake-up ping to ${endpoint} failed:`, error.message);
          }
        }

        // Wait a bit then check status
        setTimeout(checkBackend, 3000);
      }

      async function checkAdmin() {
        updateStatus("admin-status", "checking", "Checking admin interface...");

        try {
          const response = await fetch(`${API_URL}/admin/status`);
          const data = await response.json();

          if (response.ok && data.success) {
            updateStatus(
              "admin-status",
              "online",
              `‚úÖ Admin interface is available`
            );
            showResult("Admin Interface Check", true, data);
          } else {
            updateStatus("admin-status", "offline", `‚ùå Admin interface error`);
            showResult("Admin Interface Check", false, data);
          }
        } catch (error) {
          updateStatus(
            "admin-status",
            "offline",
            `‚ùå Admin interface unavailable - ${error.message}`
          );
          showResult("Admin Interface Check", false, { error: error.message });
        }
      }

      async function checkContactForm() {
        updateStatus(
          "contact-status",
          "checking",
          "Testing contact form endpoint..."
        );

        try {
          // Test with invalid data to check if endpoint is working
          const response = await fetch(`${API_URL}/contact`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ test: "validation" }),
          });

          const data = await response.json();

          if (response.status === 400 && !data.success) {
            updateStatus(
              "contact-status",
              "online",
              `‚úÖ Contact form endpoint is working (validation active)`
            );
            showResult("Contact Form Check", true, {
              message: "Endpoint working, validation active",
              data,
            });
          } else if (response.ok) {
            updateStatus(
              "contact-status",
              "online",
              `‚úÖ Contact form endpoint is working`
            );
            showResult("Contact Form Check", true, data);
          } else {
            updateStatus(
              "contact-status",
              "offline",
              `‚ùå Contact form endpoint error`
            );
            showResult("Contact Form Check", false, data);
          }
        } catch (error) {
          updateStatus(
            "contact-status",
            "offline",
            `‚ùå Contact form unavailable - ${error.message}`
          );
          showResult("Contact Form Check", false, { error: error.message });
        }
      }

      async function checkDatabase() {
        updateStatus(
          "database-status",
          "checking",
          "Checking database connection..."
        );

        try {
          const response = await fetch(`${API_URL}/projects`);
          const data = await response.json();

          if (response.ok && data.success) {
            const projectCount = data.data?.projects?.length || 0;
            updateStatus(
              "database-status",
              "online",
              `‚úÖ Database connected (${projectCount} projects)`
            );
            showResult("Database Check", true, {
              projectCount,
              sample: data.data?.projects?.[0],
            });
          } else {
            updateStatus(
              "database-status",
              "offline",
              `‚ùå Database connection error`
            );
            showResult("Database Check", false, data);
          }
        } catch (error) {
          updateStatus(
            "database-status",
            "offline",
            `‚ùå Database unavailable - ${error.message}`
          );
          showResult("Database Check", false, { error: error.message });
        }
      }

      function openAdmin() {
        window.open(`${BACKEND_URL}/admin`, "_blank");
      }

      // Auto-check on page load
      window.addEventListener("load", () => {
        setTimeout(() => {
          checkBackend();
          setTimeout(checkAdmin, 1000);
          setTimeout(checkDatabase, 2000);
          setTimeout(checkContactForm, 3000);
        }, 500);
      });
    </script>
  </body>
</html>
