<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backend Connectivity Test</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        background: #1a1a1a;
        color: #fff;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .test-section {
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
      }
      .success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4caf50;
        color: #4caf50;
      }
      .error {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid #f44336;
        color: #f44336;
      }
      .info {
        background: rgba(33, 150, 243, 0.2);
        border: 1px solid #2196f3;
        color: #2196f3;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      pre {
        background: #333;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Backend & Database Connectivity Test</h1>
      <p>
        This page tests the connection between your frontend and backend
        services.
      </p>

      <div class="test-section">
        <h2>üåê API Configuration</h2>
        <div id="api-config" class="test-result info">
          <strong>API URL:</strong> <span id="api-url"></span>
        </div>
      </div>

      <div class="test-section">
        <h2>üñ•Ô∏è Backend Health Check</h2>
        <button onclick="testBackendHealth()">Test Backend Health</button>
        <div id="backend-result"></div>
      </div>

      <div class="test-section">
        <h2>üóÑÔ∏è Database Connection Test</h2>
        <button onclick="testDatabase()">Test Database</button>
        <div id="database-result"></div>
      </div>

      <div class="test-section">
        <h2>üìß Contact Form Test</h2>
        <button onclick="testContactForm()">Test Contact Form</button>
        <div id="contact-result"></div>
      </div>

      <div class="test-section">
        <h2>üîê Admin Endpoints Test</h2>
        <button onclick="testAdminEndpoints()">Test Admin Status</button>
        <div id="admin-result"></div>
      </div>

      <div class="test-section">
        <h2>üöÄ Run All Tests</h2>
        <button onclick="runAllTests()" id="run-all-btn">Run All Tests</button>
        <div id="all-tests-result"></div>
      </div>
    </div>

    <script>
      // Determine API URL based on environment
      const apiURL =
        window.location.hostname.includes("vercel.app") ||
        window.location.hostname.includes("portfolio")
          ? "https://portfolio-xj76.onrender.com/api"
          : "http://localhost:3000/api";

      document.getElementById("api-url").textContent = apiURL;

      function showResult(elementId, success, message, details = null) {
        const element = document.getElementById(elementId);
        element.className = `test-result ${success ? "success" : "error"}`;
        element.innerHTML = `
                <strong>${success ? "‚úÖ" : "‚ùå"} ${message}</strong>
                ${
                  details
                    ? `<pre>${JSON.stringify(details, null, 2)}</pre>`
                    : ""
                }
            `;
      }

      async function testBackendHealth() {
        try {
          const response = await fetch(`${apiURL}/health`);
          const data = await response.json();

          if (response.ok && data.success) {
            showResult("backend-result", true, "Backend is healthy", {
              status: response.status,
              message: data.message,
              timestamp: data.timestamp,
            });
          } else {
            showResult(
              "backend-result",
              false,
              "Backend health check failed",
              data
            );
          }
        } catch (error) {
          showResult("backend-result", false, "Cannot connect to backend", {
            error: error.message,
            apiURL: apiURL,
          });
        }
      }

      async function testDatabase() {
        try {
          const response = await fetch(`${apiURL}/projects`);
          const data = await response.json();

          if (response.ok && data.success) {
            showResult(
              "database-result",
              true,
              "Database connection successful",
              {
                projectCount: data.data.projects.length,
                sampleProject: data.data.projects[0] || "No projects found",
              }
            );
          } else {
            showResult(
              "database-result",
              false,
              "Database connection failed",
              data
            );
          }
        } catch (error) {
          showResult(
            "database-result",
            false,
            "Cannot test database connection",
            {
              error: error.message,
            }
          );
        }
      }

      async function testContactForm() {
        try {
          // Test with invalid data to check validation
          const response = await fetch(`${apiURL}/contact`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: "Test",
              email: "invalid-email",
              subject: "Test",
              message: "Test",
            }),
          });

          const data = await response.json();

          if (response.status === 400 && !data.success) {
            showResult(
              "contact-result",
              true,
              "Contact form validation working",
              {
                status: "Validation correctly rejected invalid email",
                errors: data.errors,
              }
            );
          } else if (response.ok && data.success) {
            showResult(
              "contact-result",
              true,
              "Contact form endpoint working",
              data
            );
          } else {
            showResult(
              "contact-result",
              false,
              "Contact form test failed",
              data
            );
          }
        } catch (error) {
          showResult("contact-result", false, "Cannot test contact form", {
            error: error.message,
          });
        }
      }

      async function testAdminEndpoints() {
        try {
          const response = await fetch(`${apiURL}/admin/status`);
          const data = await response.json();

          if (response.ok && data.success) {
            showResult("admin-result", true, "Admin endpoints accessible", {
              isInitialized: data.isInitialized,
              username: data.username,
              supabaseConfigured: !!data.supabase,
            });
          } else {
            showResult(
              "admin-result",
              false,
              "Admin endpoints test failed",
              data
            );
          }
        } catch (error) {
          showResult("admin-result", false, "Cannot test admin endpoints", {
            error: error.message,
          });
        }
      }

      async function runAllTests() {
        const button = document.getElementById("run-all-btn");
        button.disabled = true;
        button.textContent = "Running Tests...";

        const results = document.getElementById("all-tests-result");
        results.innerHTML =
          '<div class="test-result info"><strong>üîÑ Running all tests...</strong></div>';

        try {
          await testBackendHealth();
          await new Promise((resolve) => setTimeout(resolve, 500));

          await testDatabase();
          await new Promise((resolve) => setTimeout(resolve, 500));

          await testContactForm();
          await new Promise((resolve) => setTimeout(resolve, 500));

          await testAdminEndpoints();

          results.innerHTML =
            '<div class="test-result success"><strong>‚úÖ All tests completed! Check individual results above.</strong></div>';
        } catch (error) {
          results.innerHTML = `<div class="test-result error"><strong>‚ùå Test suite failed: ${error.message}</strong></div>`;
        } finally {
          button.disabled = false;
          button.textContent = "Run All Tests";
        }
      }

      // Auto-run health check on page load
      window.addEventListener("load", () => {
        setTimeout(testBackendHealth, 1000);
      });
    </script>
  </body>
</html>
